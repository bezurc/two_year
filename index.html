<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Flipbook</title>

  <!-- PageFlip library CSS (recommended) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/src/Style/stPageFlip.css">

  <style>
    body { margin: 0; font-family: system-ui, sans-serif; background: #111; color: #eee; }
    header {
      position: sticky; top: 0; z-index: 10;
      display: flex; gap: 10px; align-items: center;
      padding: 10px 12px; background: rgba(0,0,0,0.8); backdrop-filter: blur(6px);
    }
    button, input {
      padding: 8px 10px; border-radius: 10px; border: 1px solid #444;
      background: #1c1c1c; color: #eee;
    }
    input { width: 76px; }
    #wrap { display: grid; place-items: center; padding: 16px; }

    /* The flip container */
    #book {
      width: min(92vw, 920px);
      height: min(72vh, 640px);
      background: transparent;
    }
    .hint { opacity: 0.8; font-size: 14px; margin-left: auto; }
  </style>
</head>

<body>
  <header>
    <button id="prev">⟵ Prev</button>
    <button id="next">Next ⟶</button>
    <span>Page</span>
    <input id="pageInput" type="number" min="1" />
    <span id="pageTotal"></span>
    <span class="hint">Drag corners / swipe</span>
  </header>

  <div id="wrap">
    <div id="book"></div>
  </div>

<script type="module">
  import { PageFlip } from "https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.module.js";

  const PAGE_COUNT = 30;
  const pages = Array.from({ length: PAGE_COUNT }, (_, i) => `${i + 1}.png`);

  const bookEl = document.getElementById("book");
  const pageInput = document.getElementById("pageInput");
  const pageTotal = document.getElementById("pageTotal");
  pageTotal.textContent = `of ${PAGE_COUNT}`;
  pageInput.max = String(PAGE_COUNT);
  pageInput.value = "1";

  let pageFlip = null;
  let currentIndex = 0;

  function isMobile() {
    return window.matchMedia("(max-width: 640px)").matches;
  }

  function buildSettings() {
    // Tune these. The idea:
    // - mobile: smaller base size, portrait mode feel, allow stretching to fit screen
    // - desktop: bigger base size but cap max so it doesn't blow up and blur
    if (isMobile()) {
      return {
        width: 320,
        height: 480,
        size: "stretch",
        minWidth: 240,
        maxWidth: 520,
        minHeight: 360,
        maxHeight: 800,
        showCover: true,
        useMouseEvents: true,
        mobileScrollSupport: true,
        maxShadowOpacity: 0.35,
      };
    }

    // Desktop / larger screens
    return {
      width: 460,
      height: 640,
      size: "stretch",
      minWidth: 315,
      maxWidth: 920,     // cap growth to reduce blur
      minHeight: 420,
      maxHeight: 1280,   // cap growth to reduce blur
      showCover: true,
      useMouseEvents: true,
      mobileScrollSupport: false,
      maxShadowOpacity: 0.35,
    };
  }

  async function initFlipbook(keepPage = true) {
    const keepIndex = keepPage ? currentIndex : 0;

    // If a previous instance exists, destroy it cleanly
    if (pageFlip) {
      try { pageFlip.destroy(); } catch (e) {}
      pageFlip = null;
      bookEl.innerHTML = ""; // clear DOM remnants
    }

    pageFlip = new PageFlip(bookEl, buildSettings());

    // Load images
    pageFlip.loadFromImages(pages);

    // Jump back to previous page after rebuild
    if (keepIndex > 0) {
      // PageFlip sometimes needs a tick after load
      setTimeout(() => pageFlip.flip(keepIndex), 0);
    }

    // Events
    pageFlip.on("flip", () => {
      currentIndex = pageFlip.getCurrentPageIndex();
      pageInput.value = String(currentIndex + 1);
    });

    // Initialize UI
    currentIndex = keepIndex;
    pageInput.value = String(currentIndex + 1);
  }

  // Buttons / input
  document.getElementById("prev").onclick = () => pageFlip?.flipPrev();
  document.getElementById("next").onclick = () => pageFlip?.flipNext();

  pageInput.addEventListener("change", () => {
    const n = parseInt(pageInput.value, 10);
    if (!Number.isFinite(n) || n < 1 || n > PAGE_COUNT) return;
    currentIndex = n - 1;
    pageFlip?.flip(currentIndex);
  });

  // Rebuild on resize/orientation change (keeps current page)
  let resizeTimer = null;
  window.addEventListener("resize", () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => initFlipbook(true), 200);
  });

  // Start
  initFlipbook(false);
</script>

</body>
</html>
